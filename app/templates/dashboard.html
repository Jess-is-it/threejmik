{% extends "base.html" %}
{% block content %}
<div class="row row-cards mt-3">
  <div class="col-sm-6 col-lg-4">
    <div class="card rv-kpi-card" data-bs-toggle="tooltip" title="Total routers configured in RouterVault.">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="subheader">Total Routers</div>
          <div class="ms-auto">
            <i class="ti ti-router text-secondary"></i>
          </div>
        </div>
        <div class="h1 mb-0" id="rv-kpi-total-routers">{{ total_routers }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-4">
    <div class="card rv-kpi-card" data-bs-toggle="tooltip" title="Connected routers estimate (no last error recorded).">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="subheader">Connected Routers</div>
          <div class="ms-auto">
            <i class="ti ti-link text-secondary"></i>
          </div>
        </div>
        <div class="h1 mb-0" id="rv-kpi-connected-routers">{{ connected_routers }}/{{ total_routers }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-4">
    {% set alerts_unread = (alerts_total - alerts_viewed) %}
    <a class="card card-link rv-kpi-card rv-kpi-clickable" href="#" data-bs-toggle="offcanvas" data-bs-target="#rv-alerts-drawer" aria-controls="rv-alerts-drawer" title="Viewed / total alerts">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="subheader">Alerts</div>
          <div class="ms-auto d-flex align-items-center gap-2">
            {% if alerts_unread > 0 %}
            <span class="badge bg-red text-white" data-bs-toggle="tooltip" title="Unread alerts" id="rv-alerts-unread-badge">{{ alerts_unread }}</span>
            {% endif %}
            <i class="ti ti-alert-triangle text-secondary"></i>
          </div>
        </div>
        <div class="h1 mb-0" id="rv-alerts-kpi">{{ alerts_viewed }}/{{ alerts_total }}</div>
      </div>
    </a>
  </div>
</div>

<div class="card mt-3">
  <div class="table-responsive">
	        <table class="table card-table table-vcenter">
	          <thead>
	            <tr>
	              <th data-bs-toggle="tooltip" title="Router name and status.">Router</th>
              <th data-bs-toggle="tooltip" title="Quick stats for this router.">KPIs</th>
              <th data-bs-toggle="tooltip" title="Last time RouterVault created a backup.">Last Backup</th>
              <th data-bs-toggle="tooltip" title="Last successful backup time.">Last Success</th>
              <th data-bs-toggle="tooltip" title="Most recent error recorded for this router.">Last Error</th>
            </tr>
          </thead>
      <tbody>
	        {% for router in routers %}
	        {% set kpi = router_kpis.get(router.id, {"total_backups": 0, "auto_backups": 0, "auto_forced_backups": 0, "manual_backups": 0}) %}
		        <tr data-router-id="{{ router.id }}">
		          <td>
	              {% set connected = is_connected_router(router) %}
	              <span class="rv-status-emoji me-1 rv-router-status" data-bs-toggle="tooltip" title="{{ 'Connected' if connected else 'Disconnected (last error recorded)' }}">
	                {{ "ðŸŸ¢" if connected else "ðŸ”´" }}
	              </span>
	              <a href="/backups?router_id={{ router.id }}">{{ router.name }}</a>
	            </td>
	          <td>
	            <span class="badge bg-azure text-white" data-bs-toggle="tooltip" title="Total backups stored for this router.">Total: {{ kpi.total_backups }}</span>
	            <span class="badge bg-green text-white" data-bs-toggle="tooltip" title="Backups created automatically by RouterVault (scheduler/change detection).">Auto: {{ kpi.auto_backups }}</span>
	            <span class="badge bg-orange text-white" data-bs-toggle="tooltip" title="Auto backups created because the router's force-backup window was reached.">Auto forced: {{ kpi.auto_forced_backups }}</span>
            <span class="badge bg-indigo text-white" data-bs-toggle="tooltip" title="Backups created when you click Manual Backup.">Manual: {{ kpi.manual_backups }}</span>
          </td>
	          <td class="rv-last-backup">{{ format_ts_ph(router.last_backup_at) }}</td>
	          <td class="rv-last-success">
	            <span class="rv-last-success-ts">{{ format_ts_ph(router.last_success_at) }}</span>
	            {% if is_stale_router(router) %}
	            <span class="badge bg-red text-white rv-stale-badge" data-bs-toggle="tooltip" title="Last successful backup is older than this router's Force backup after (days).">Stale</span>
	            {% endif %}
	          </td>
	          <td>
              {% if router.last_error %}
                <span class="rv-ellipsis rv-last-error" data-bs-toggle="tooltip" title="{{ router.last_error }}">{{ router.last_error }}</span>
              {% else %}
                <span class="rv-last-error">-</span>
              {% endif %}
            </td>
	        </tr>
	        {% else %}
	        <tr><td colspan="5" class="text-secondary">No routers registered yet.</td></tr>
	        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="rv-alerts-drawer" aria-labelledby="rv-alerts-title">
  <div class="offcanvas-header">
    <h2 class="offcanvas-title" id="rv-alerts-title">Alerts</h2>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body pt-0">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="text-secondary">Newest first</div>
      <button class="btn btn-outline-secondary btn-sm" type="button" id="rv-alerts-mark-read">Mark all read</button>
    </div>
    <div class="list-group list-group-flush" id="rv-alerts-list">
      {% for alert in alerts %}
      {% set is_new = not alert.viewed_at %}
      <div class="list-group-item rv-alert-item {% if is_new %}rv-alert-new{% endif %}" data-alert-new="{{ 1 if is_new else 0 }}">
        <div class="d-flex align-items-start gap-3">
          <div class="pt-1">
            {% if alert.level == 'error' %}
              <i class="ti ti-alert-circle text-danger"></i>
            {% elif alert.level == 'warning' %}
              <i class="ti ti-alert-triangle text-warning"></i>
            {% else %}
              <i class="ti ti-info-circle text-secondary"></i>
            {% endif %}
          </div>
          <div class="flex-grow-1 min-w-0">
            <div class="d-flex align-items-center gap-2">
              <div class="rv-alert-title fw-semibold text-truncate {% if is_new %}rv-alert-title-new{% endif %}">{{ alert.title }}</div>
              {% if is_new %}
              <span class="badge bg-azure text-white rv-alert-badge-new">New</span>
              {% endif %}
            </div>
            <div class="text-secondary small">
              {% if alert.router_name %}{{ alert.router_name }} Â· {% endif %}{{ format_ts_ph(alert.created_at) }}
            </div>
            <div class="mt-2 rv-alert-message">{{ alert.message }}</div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="list-group-item text-secondary">No alerts yet.</div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  (() => {
    const drawer = document.getElementById("rv-alerts-drawer");
    const kpi = document.getElementById("rv-alerts-kpi");
    const btnMark = document.getElementById("rv-alerts-mark-read");
    if (!drawer || !kpi || !btnMark) return;

    const markRead = async () => {
      try {
        const res = await fetch("/alerts/viewed", { method: "POST" });
        const payload = await res.json();
        if (payload && payload.ok) {
          kpi.textContent = `${payload.viewed}/${payload.total}`;
        }
      } catch (e) {
        // ignore
      }
      const items = drawer.querySelectorAll(".rv-alert-item");
      for (const item of items) {
        item.classList.remove("rv-alert-new");
        const badge = item.querySelector(".rv-alert-badge-new");
        if (badge) badge.remove();
      }
      const unreadBadge = document.querySelector('.rv-kpi-clickable .badge.bg-red');
      if (unreadBadge) unreadBadge.remove();
    };

    drawer.addEventListener("shown.bs.offcanvas", () => {
      markRead();
    });
    btnMark.addEventListener("click", () => {
      markRead();
    });
  })();
</script>

<script>
  (() => {
    const elTotalRouters = document.getElementById("rv-kpi-total-routers");
    const elConnectedRouters = document.getElementById("rv-kpi-connected-routers");
    const elAlertsKpi = document.getElementById("rv-alerts-kpi");
    const elUnreadBadge = document.getElementById("rv-alerts-unread-badge");
    const alertsDrawer = document.getElementById("rv-alerts-drawer");
    const alertsList = document.getElementById("rv-alerts-list");
    if (!elTotalRouters || !elConnectedRouters || !elAlertsKpi) return;

    const ensureTooltip = (el, title) => {
      if (!el) return;
      el.setAttribute("title", title || "");
      el.setAttribute("data-bs-original-title", title || "");
      if (window.bootstrap && bootstrap.Tooltip) {
        const inst = bootstrap.Tooltip.getInstance(el);
        if (inst) inst.dispose();
        if (title) new bootstrap.Tooltip(el);
      }
    };

    const setUnreadBadge = (unread) => {
      const parent = document.querySelector(".rv-kpi-clickable .ms-auto");
      const existing = document.getElementById("rv-alerts-unread-badge");
      if (!parent) return;
      if (unread > 0) {
        if (existing) {
          existing.textContent = String(unread);
          return;
        }
        const badge = document.createElement("span");
        badge.id = "rv-alerts-unread-badge";
        badge.className = "badge bg-red text-white";
        badge.setAttribute("data-bs-toggle", "tooltip");
        badge.textContent = String(unread);
        ensureTooltip(badge, "Unread alerts");
        parent.prepend(badge);
      } else if (existing) {
        existing.remove();
      }
    };

    const renderAlerts = (alerts) => {
      if (!alertsList) return;
      alertsList.innerHTML = "";
      if (!alerts || alerts.length === 0) {
        const empty = document.createElement("div");
        empty.className = "list-group-item text-secondary";
        empty.textContent = "No alerts yet.";
        alertsList.appendChild(empty);
        return;
      }
      for (const alert of alerts) {
        const item = document.createElement("div");
        item.className = "list-group-item rv-alert-item";
        if (alert.is_new) item.classList.add("rv-alert-new");

        const row = document.createElement("div");
        row.className = "d-flex align-items-start gap-3";

        const iconWrap = document.createElement("div");
        iconWrap.className = "pt-1";
        const icon = document.createElement("i");
        if (alert.level === "error") icon.className = "ti ti-alert-circle text-danger";
        else if (alert.level === "warning") icon.className = "ti ti-alert-triangle text-warning";
        else icon.className = "ti ti-info-circle text-secondary";
        iconWrap.appendChild(icon);

        const body = document.createElement("div");
        body.className = "flex-grow-1 min-w-0";

        const titleRow = document.createElement("div");
        titleRow.className = "d-flex align-items-center gap-2";
        const title = document.createElement("div");
        title.className = "rv-alert-title fw-semibold text-truncate";
        if (alert.is_new) title.classList.add("rv-alert-title-new");
        title.textContent = alert.title || "";
        titleRow.appendChild(title);
        if (alert.is_new) {
          const badge = document.createElement("span");
          badge.className = "badge bg-azure text-white rv-alert-badge-new";
          badge.textContent = "New";
          titleRow.appendChild(badge);
        }

        const meta = document.createElement("div");
        meta.className = "text-secondary small";
        const routerName = alert.router_name ? `${alert.router_name} Â· ` : "";
        meta.textContent = `${routerName}${alert.created_at_ph || ""}`.trim();

        const msg = document.createElement("div");
        msg.className = "mt-2 rv-alert-message";
        msg.textContent = alert.message || "";

        body.appendChild(titleRow);
        body.appendChild(meta);
        body.appendChild(msg);

        row.appendChild(iconWrap);
        row.appendChild(body);
        item.appendChild(row);
        alertsList.appendChild(item);
      }
    };

    const updateRouters = (routers) => {
      if (!routers) return;
      for (const router of routers) {
        const tr = document.querySelector(`tr[data-router-id="${router.id}"]`);
        if (!tr) continue;

        const status = tr.querySelector(".rv-router-status");
        if (status) {
          status.textContent = router.connected ? "ðŸŸ¢" : "ðŸ”´";
          ensureTooltip(status, router.connected ? "Connected" : "Disconnected (last error recorded)");
        }

        const lastBackup = tr.querySelector(".rv-last-backup");
        if (lastBackup) lastBackup.textContent = router.last_backup_at_ph || "-";

        const lastSuccess = tr.querySelector(".rv-last-success-ts");
        if (lastSuccess) lastSuccess.textContent = router.last_success_at_ph || "-";

        const staleBadge = tr.querySelector(".rv-stale-badge");
        if (router.is_stale) {
          if (!staleBadge) {
            const span = document.createElement("span");
            span.className = "badge bg-red text-white rv-stale-badge";
            span.setAttribute("data-bs-toggle", "tooltip");
            span.textContent = "Stale";
            ensureTooltip(span, "Last successful backup is older than this router's Force backup after (days).");
            const cell = tr.querySelector(".rv-last-success");
            if (cell) cell.appendChild(document.createTextNode(" "));
            if (cell) cell.appendChild(span);
          }
        } else if (staleBadge) {
          staleBadge.remove();
        }

        const lastError = tr.querySelector(".rv-last-error");
        if (lastError) {
          const text = router.last_error ? router.last_error : "-";
          lastError.textContent = text;
          ensureTooltip(lastError, router.last_error || "");
        }
      }
    };

    const poll = async () => {
      try {
        const res = await fetch("/api/dashboard/poll", { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        elTotalRouters.textContent = String(data.total_routers ?? "-");
        elConnectedRouters.textContent = `${data.connected_routers ?? "-"}/${data.total_routers ?? "-"}`;
        elAlertsKpi.textContent = `${data.alerts_viewed ?? 0}/${data.alerts_total ?? 0}`;
        setUnreadBadge(Number(data.alerts_unread || 0));
        updateRouters(data.routers || []);
        if (alertsDrawer && alertsDrawer.classList.contains("show")) {
          renderAlerts(data.recent_alerts || []);
        }
      } catch (e) {
        // ignore transient failures
      }
    };

    poll();
    window.setInterval(poll, 5000);
  })();
</script>
{% endblock %}

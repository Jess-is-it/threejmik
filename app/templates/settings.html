{% extends "base.html" %}
{% from "_macros.html" import tip %}
{% block content %}
<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">Settings</h2>
      <div class="text-secondary">Global monitoring thresholds.</div>
    </div>
  </div>
</div>
<form method="post" action="/settings">
  <div class="card mb-4">
    <div class="card-header"><h3 class="card-title">Authentication</h3></div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Username {{ tip("Basic Auth username used to access the RouterVault web UI.") }}</label>
        <input class="form-control" name="basic_user" value="{{ settings.basic_user or '' }}" placeholder="admin" data-bs-toggle="tooltip" title="Basic Auth username for the web UI.">
      </div>
      <div class="mb-3">
        <label class="form-label">Password {{ tip("Basic Auth password. Leave blank to keep the current password.") }}</label>
        <input class="form-control" name="basic_password" type="password" value="" placeholder="Leave blank to keep current password" data-bs-toggle="tooltip" title="Leave blank to keep the current password.">
      </div>
      <div class="text-secondary">Changes apply immediately on next request.</div>
    </div>
  </div>
  <div class="card mb-4">
    <div class="card-header"><h3 class="card-title">MikroTik</h3></div>
    <div class="card-body">
      <label class="form-check form-switch">
        <input class="form-check-input" type="checkbox" name="mock_mode" value="1" {% if settings.mock_mode %}checked{% endif %}>
        <span class="form-check-label">Mock Mode (simulate router API/exports) {{ tip("Enable to simulate MikroTik API and file operations for UI testing. Disable for real backups.") }}</span>
      </label>
      <label class="form-check form-switch mt-3">
        <input class="form-check-input" type="checkbox" name="export_show_sensitive" value="1" {% if settings.export_show_sensitive %}checked{% endif %}>
        <span class="form-check-label">Include sensitive values in .rsc exports (passwords) {{ tip("If enabled, RouterVault requests RouterOS exports with show-sensitive=yes (includes passwords/secrets in the .rsc).") }}</span>
      </label>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h3 class="card-title">Telegram</h3></div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Bot Token {{ tip("Telegram bot token used to send notifications.") }}</label>
        <input class="form-control" name="telegram_token" value="{{ settings.telegram_token or '' }}" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11" data-bs-toggle="tooltip" title="Telegram bot token.">
      </div>
      <div class="mb-3">
        <label class="form-label">Chat ID {{ tip("Comma-separated Telegram chat IDs to receive notifications.") }}</label>
        <input class="form-control" name="telegram_recipients" value="{{ settings.telegram_recipients or '' }}" placeholder="-1001234567890" data-bs-toggle="tooltip" title="Comma-separated chat IDs (e.g. -100123...).">
      </div>
    </div>
    <div class="card-footer text-end">
      <button class="btn btn-primary" type="submit">Save Settings</button>
    </div>
  </div>
</form>

<div class="card mt-4 border-danger">
  <div class="card-header bg-danger-lt">
    <h3 class="card-title text-danger mb-0">Danger!</h3>
  </div>
  <div class="card-body">
    <div class="alert alert-danger" role="alert">
      <strong>Format Backup Database</strong><br>
      This will remove all backups and logs from the database and delete backup/rsc files on disk. Routers are not deleted unless you explicitly choose to include them. This cannot be undone.
    </div>
    <form method="post" action="/settings/format-backups" onsubmit="return confirmFormat(this);">
      <div class="mb-3">
        <label class="form-label">Type <strong>format</strong> to confirm</label>
        <input class="form-control" name="confirm_word" placeholder="format" required>
      </div>
      <div class="mb-3 form-check">
        <input class="form-check-input" type="checkbox" name="include_routers" value="1" id="includeRoutersCheck">
        <label class="form-check-label text-danger" for="includeRoutersCheck">Also delete routers (all saved router entries)</label>
      </div>
      <button class="btn btn-danger" type="submit">Format Backup Database</button>
    </form>
  </div>
</div>
<script>
  function confirmFormat(form) {
    const input = form.querySelector('input[name="confirm_word"]');
    if (!input) return false;
    const ok = (input.value || "").trim().toLowerCase() === "format";
    if (!ok) {
      alert('Please type "format" to confirm.');
      return false;
    }
    return confirm("Are you sure? This will clear backups/logs in the database.");
  }
</script>
{% endblock %}
